# **📝 FactorBacktester v2.2 개발 명세서 (최종 버전)**

**프로젝트 목표**: factor\_backtesting.py의 로직을 기반으로, 시스템을 **일간 데이터** 기준으로 전면 개편하고, **모멘텀** 및 정교화된 **파마-프렌치 3팩터 알파** 전략을 포함한 총 4개의 핵심 전략을 구현한다.

### **1\. 핵심 변경 사항**

1. **데이터 처리 기준 변경**: 모든 데이터 처리 및 백테스팅의 기준 단위를 \*\*일간(daily)\*\*으로 변경한다.  
2. **투자 전략 집중**: **마법 공식, F-스코어, 모멘텀, 파마-프렌치 3팩터 알파** 총 4개 전략에 집중하여 구현한다.

### **2\. 데이터 처리 아키텍처 및 절차**

#### **2.1. DataHandler의 역할 및 데이터 처리 순서**

1. **일간 주가 데이터 통합**:  
   * data/raw 디렉토리에서 2012.csv, ..., 2023.csv 등 일간 주가 데이터 파일들을 모두 로드하여 하나의 데이터프레임(daily\_price\_df)으로 병합한다. 이 데이터는 일간 시가총액을 포함하며, 이 컬럼은 \*\*일간\_시가총액\*\*으로 명명한다.  
   * 회계년도 컬럼의 값을 숫자 형식으로 정리하되, **컬럼명은 '회계년도'를 그대로 유지한다.** (예: '2012/12' \-\> 2012\)  
   * 매매년월일 컬럼을 datetime 형식의 date 컬럼으로 표준화한다.  
2. **연간 데이터 준비**:  
   * FS2.csv(재무 데이터)와 시가총액.csv(연간 기준 시가총액 데이터)를 로드한다.  
   * **부실기업 여부를 나타내는 default 컬럼은 FS2.csv 파일에 포함되어 있는 것을 전제로 한다.**  
   * 시가총액.csv의 시가총액은 우선주가 포함된 정확한 연간 기준 값이므로, **연간\_시가총액** 컬럼명으로 관리한다.  
3. **마스터 데이터프레임 생성 (미래 정보 편향 방지)**:  
   * **핵심 규칙**: 특정 거래일 t에 연결되는 재무 데이터는, **t 시점에서 투자자가 합리적으로 인지할 수 있는 가장 최신의 확정된 재무 데이터**여야 한다.  
   * **구현**: daily\_price\_df의 date를 기준으로, 해당 날짜보다 이전이면서 가장 가까운 **재무제표 발표일 이후의 데이터**를 연결한다. 예를 들어, 2023년 4월 1일부터 2024년 3월 31일까지의 모든 거래일에는 **2022년 회계년도의 재무 데이터 및 연간\_시가총액** 이 연결되어야 한다.

#### **2.2. 클래스 설계**

* **DataHandler**: 상기 2.1 절차에 따라 최종 일간 마스터 데이터를 생성한다.  
* **FactorEngine**: 팩터 시그널을 계산한다.  
* **StrategyBuilder**: 포트폴리오를 구성한다.  
* **BacktestEngine**: 백테스트 시뮬레이션을 실행한다.  
* **PerformanceAnalyzer**: 성과를 분석하고 보고서를 생성한다.

### **3\. 구현할 투자 전략 (4가지) \- 상세 설명**

#### **3.1. 마법 공식 (Magic Formula) & 3.2. 피오트로스키 F-스코어 (Piotroski F-Score)**

* **구현 기준**: **factor\_backtesting.py 파일의 \_compute\_magic\_formula와 \_compute\_fscore 메서드 구현 방식을 그대로 따른다.**  
* **데이터 활용**:  
  * EV(기업가치) 등 가치 지표 계산 시, \*\*리밸런싱 당일의 일간\_시가총액\*\*을 사용한다.  
  * ROIC, F-스코어 항목 등 재무 지표는 리밸런싱 시점에 유효한 연간 재무 데이터를 사용한다.  
* **포트폴리오 선택**:  
  * **마법 공식**: 합산 순위가 가장 낮은 상위 N개 종목 (portfolio\_size)을 선택한다.  
  * **F-스코어**: min\_score 이상인 모든 종목을 편입한다.

#### **3.3. 모멘텀 팩터 전략 (Momentum Factor Strategy)**

* **로직**: 일간 가격 데이터를 사용하여 과거 N개월간의 수익률이 높았던 주식에 투자한다.  
  * **모멘텀 계산**: 리밸런싱 시점 t를 기준으로, 과거 t \- lookback\_period 부터 t \- skip\_period 까지의 누적 수익률을 계산한다. (예: 12-1 모멘텀)  
  * **포트폴리오 선택**: 계산된 모멘텀 수익률이 가장 높은 상위 N개 종목 (portfolio\_size)을 선택한다.

#### **3.4. 파마-프렌치 3-Factor 알파 전략 (상세)**

* **개요**: 시장의 체계적 위험(시장, 규모, 가치)으로 설명되지 않는 진정한 초과 수익률, 즉 '알파(α)'를 발굴하여 투자하는 전략.  
* **세부 로직**:  
  1. **1단계: FF3 팩터 시계열 데이터 구축 (FactorEngine에서 수행)**  
     * **Mkt-RF (시장 위험 프리미엄)**: yfinance 라이브러리를 사용하여 KOSPI 지수(티커: ^KS11)의 월별 수정종가 수익률을 계산한다. **무위험 이자율은 pykrx.bond.get\_otc\_treasury\_yields를 통해 'CD(91일)' 금리를 월별로 가져오는 것을 우선**으로 하며, 데이터 획득 실패 시 config.yaml의 고정값을 사용한다.  
     * **SMB (Small Minus Big) / HML (High Minus Low) 구축**:  
       * **포트폴리오 구성 시점**: **매년 6월 말**.  
       * **Size 기준**: 모든 상장 주식을 **연간\_시가총액** 순으로 정렬하여 **상위 50%를 'Big', 하위 50%를 'Small'** 그룹으로 나눈다.  
       * **Value 기준**: 모든 상장 주식을 **B/M 비율(자본총계 / 연간\_시가총액)** 순으로 정렬하여 **상위 30%를 'High'(가치주), 중위 40%를 'Medium', 하위 30%를 'Low'(성장주)** 그룹으로 나눈다.  
       * **6개 포트폴리오 생성**: 위 두 기준을 교차하여 총 6개의 포트폴리오(S/L, S/M, S/H, B/L, B/M, B/H)를 구성한다.  
       * **월별 수익률 계산**: 구성된 6개 포트폴리오를 다음 해 6월까지 12개월 동안 보유했을 때의 월별 수익률을 **시가총액 가중평균**하여 계산한다.  
       * **SMB 팩터 수익률**: (Small/Low \+ Small/Medium \+ Small/High)/3 \- (Big/Low \+ Big/Medium \+ Big/High)/3  
       * **HML 팩터 수익률**: (Small/High \+ Big/High)/2 \- (Small/Low \+ Big/Low)/2  
     * 위 과정을 통해 전체 기간에 대한 월별 Mkt-RF, SMB, HML 팩터 시계열 데이터를 완성한다.  
  2. **2단계: 개별 주식 회귀분석 및 알파(α) 발굴 (StrategyBuilder에서 수행)**  
     * **리밸런싱 시점 (매년 7월 1일)**, 유니버스 내 모든 개별 주식에 대해 과거 regression\_window (예: 24개월) 동안의 월별 초과 수익률을 종속 변수로, 1단계에서 구한 FF3 팩터들을 독립 변수로 사용하여 회귀분석을 실행한다. **단, 분석에 필요한 최소 데이터 기간은 12개월 이상이어야 하며, 이보다 짧을 경우 해당 종목은 분석에서 제외한다.**  
     * **회귀식**: Stock\_Excess\_Return \= α \+ β\_mkt \* Mkt-RF \+ β\_smb \* SMB \+ β\_hml \* HML  
     * **포트폴리오 선택**:  
       * **조건 1**: 회귀분석으로 추정된 α \> 0  
       * **조건 2**: α의 p-value \< alpha\_pvalue\_threshold (예: 0.1)  
       * 위 두 조건을 모두 만족하는 종목들을 **알파(α) 값의 크기 순**으로 정렬하여 상위 N개 종목 (portfolio\_size)을 선택한다.

### **4\. 백테스팅 및 리밸런싱 상세**

* **백테스팅 단위**: 모든 시뮬레이션은 일간 타임스탬프 기준으로 처리한다.  
* **리밸런싱 주기**:  
  * **Magic Formula, F-Score, Momentum**: **매년 4월 1일** 연 1회 리밸런싱.  
  * **FF3-Alpha 전략**: **매년 7월 1일** 연 1회 리밸런싱.  
* **테스트 유니버스 분리**: 백테스팅은 아래 두 개의 유니버스에 대해 각각 실행한다.  
  * **전체 기업군 (All Firms)**: 필터링되지 않은 전체 종목 대상.  
  * **정상 기업군 (Normal Firms)**: 리밸런싱 시점에 default 컬럼 값이 0인 기업만 대상.  
* **예외 처리 규칙**:  
  * **상장 폐지**: 기간 중 상장 폐지된 종목은 폐지 시점까지의 수익률을 반영하고, 남은 현금은 다음 리밸런싱까지 무위험 이자율로 운용한다.  
  * **데이터 누락**: 리밸런싱 시점에 팩터 계산에 필요한 데이터가 없는 종목은 투자 유니버스에서 제외한다.  
  * **회귀분석 실패**: FF3-Alpha 전략에서, 과거 데이터 부족 등으로 회귀분석이 실패하는 종목은 분석 대상에서 제외한다.

### **5\. 설정 파일 (config.yaml) 구조**

\# config.yaml (v2.2 예시)

\# 1\. 기본 설정  
data\_paths:  
  price\_data\_dir: 'data/raw'  
  fundamental: 'data/processed/FS2\_default.csv'  
  market\_cap: 'data/processed/시가총액.csv'  
output\_dir: 'outputs/backtesting\_v2.2'  
start\_date: '2013-04-01'  
end\_date: '2023-12-31'  
benchmark\_ticker: '^KS11' \# yfinance KOSPI 티커  
risk\_free\_rate\_fallback: 0.02 \# pykrx 실패 시 사용할 고정 무위험 이자율 (연 2%)

\# 2\. 포트폴리오 설정  
portfolio\_params:  
  portfolio\_size: 20  
  weighting\_scheme: 'Equal'

\# 3\. 전략별 세부 설정  
strategy\_params:  
  f\_score:  
    min\_score: 8  
  ff3\_alpha:  
    regression\_window: 24  
    alpha\_pvalue\_threshold: 0.1  
  momentum:  
    lookback\_period: 12  
    skip\_period: 1

\# 4\. 거래 비용 설정  
transaction\_costs:  
  commission\_rate: 0.00015  
  tax\_rate: 0.0018  
  slippage\_rate: 0.0005

### **6\. 성과 분석 및 시각화**

* **성과 지표**: 아래의 주요 지표들을 모두 계산한다.  
  * **기본 지표**: CAGR, 연간 변동성, 샤프 비율(Sharpe Ratio), 최대 낙폭(MDD), 칼마 비율(Calmar Ratio)  
  * **위험 조정 수익률**: **소르티노 비율 (Sortino Ratio)** \- 하락 위험 대비 초과 수익률  
  * **벤치마크 대비 성과**:  
    * **베타 (Beta)** \- 시장 민감도  
    * **정보 비율 (Information Ratio)** \- 벤치마크 대비 초과 수익의 안정성  
* **시각화**: 각 전략에 대해 '전체 기업군'과 '정상 기업군'의 누적 수익률 곡선을 하나의 차트에 함께 그려 시각적으로 비교한다.  
* **수치 비교표**: 최종 HTML 보고서에 아래와 같은 형식의 상세 비교 테이블을 포함하여, 부실기업 제거 효과를 명확하게 분석한다.

| 전략명 | 성과 지표 | 전체 기업군 | 정상 기업군 | 성과 차이 |
| :---- | :---- | :---- | :---- | :---- |
| Magic Formula | CAGR | 15.2% | 18.5% | **\+3.3%p** |
|  | MDD | \-25.0% | \-20.1% | **\+4.9%p** |
|  | Sharpe | 0.85 | 1.02 | **\+0.17** |
|  | **Sortino** | 1.21 | 1.55 | **\+0.34** |
|  | **Beta** | 1.10 | 0.95 | **\-0.15** |
|  | **Info Ratio** | 0.55 | 0.78 | **\+0.23** |
| F-Score | CAGR | 12.1% | 14.3% | **\+2.2%p** |
|  | ... | ... | ... | ... |

